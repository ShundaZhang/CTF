from pwn import *
from Crypto.Util.number import *
import gmpy2

p = 165674320538257119618935777569264633493104025830012248611472894731246968925696662635145647004418760425271620056052110213831898075813625940406354655699229763954183325349451697961823730258851477789232732720256524106366149483534442882933118436805397696618238112020186478083571097834483155523153453888627684702401
p1 = [2,2,2,2,2,2,3,5,5,7,11,13,19,23,31,37,61,71,181,229,233,241,401,433,1021,1033,5237,15601,15881,77621,101701,136531,600241,675889,39785017,18590197861,2110175168929,62270035466201,708791106674191,3388917958905421,297934315348629678161,343722324162224502721,4258346124311062016361408601,196833670484920623077625618471272401,3277953273564812642861575873943801232248811019050895081]
p2 = [3] * 241 + [41] * 120

q = 136319579751776446060762594173031311688966678940151526541501511333981751346927563082795749698154881610675192169672633902518187425468160661847068557813564166633080060747936338201910247175316115399953152558661099756476138183615339201940322678359899950385796675849521347379659664940470524326676056070490217094401
q1 = [2,2,2,2,2,2,2,2,3,5,5,7,11,13,17,41,73,101,113,401,1321,4481,12401,36913,46861,54497,204311,261071,8652401,24999521,1357901521,3961916417,29040743441,41589844801,17122630828217,45459230802631,4602336982581694499761,25659752338627001628771761,59522626340600884948348798081,133240651584560734013410462245281,214523217697063175741941761486481,375423311348937549351028930453201]
q2 = [3] * 81 + [2357] * 80

def phi(pr):
    mp = defaultdict(lambda: 0)
    for pp in pr:
        mp[pp] += 1
    ph = 1
    for k, v in mp.items():
        ph *= (k - 1) * k ** (v - 1)
    return ph

s = remote("00.cr.yp.toc.tf", 13371)
s.recvlines(4)
s.sendline(f"{p},{q}".encode())
s.recvuntil(b"c1 = ")
c1 = int(s.recvline())
s.recvuntil(b"c2 = ")
c2 = int(s.recvline())
phi1 = phi(p1 + q1)
phi2 = phi(p2 + q2)
n1 = (p - 1) * (q - 1)
n2 = (2*p + 1) * (2*q + 1)

print(gmpy2.gcd(c1, n1), gmpy2.gcd(c2, n2))

d1 = pow(65537, -1, phi1)
d2 = pow(65537, -1, phi2)
m1 = pow(c1, d1, n1)
m2 = pow(c2, d2, n2)
m = long_to_bytes(m1) + long_to_bytes(m2)
print(m)
s.sendline(m)
print(s.recvall())

#Try many times...
#CCTF{i_l0v3_5UpeR_S4fE_Pr1m3s!!}
